# 红队 C2 系统 PRD 与技术设计文档（整合版）

**版本：1.2**
**目标平台：Golang 1.23.5或更高版本**
**系统类型：红队合法测试使用的 C2 框架**
**开发语言：Go**

## 1. 项目背景与目标

### 1.1 项目背景

在合法授权的渗透测试中，红队常需要构建一个灵活、模块化且隐蔽的指挥控制（C2）平台。该平台应具备多协议监听能力、加密通信及模块化扩展能力，从而模拟真实攻击环境，帮助测试防御体系的检测与响应能力。

### 1.2 项目目标
- **多协议监听**：支持 TCP、ICMP、DNS、HTTP/2、WebSocket 等协议监听，允许在不冲突的前提下任意组合启动、销毁、停止监听实例，并能实时查询状态。
- **加密通信**：支持 chacha20 与 aes 两种加密模式，通过协议头实现自动识别和切换，并实现基于 ECDHE 的密钥交换与轮换机制。
- **统一协议层**：将数据处理、加解密、流量封装整合到统一的协议层，方便扩展和维护。
- **任务与客户端管理**：Server 端负责任务分发、客户端连接管理及下发模块，支持智能化任务调度和优先级管理。
- **模块化扩展**：客户端本体仅负责维持与 Server 的连接；功能（如 shell、文件管理等）均采用多种跨平台兼容的方式执行，支持 Server 远程下发模块。
- **Client Builder**：通过 Builder 工具生成客户端可执行文件，支持命令行参数指定内置协议（如 tcp,dns）及内置模块（如 shell）。 Builder 还应支持主动（超时自动切换协议）和被动（Server 指令切换协议）的协议切换机制。
- **反检测与隐蔽性**：实现流量混淆、行为伪装及反分析技术，提高 C2 通信的隐蔽性与安全性，包括对抗机器学习检测的能力。
- **可视化管理界面**：提供基于Web的管理界面，支持对Listener、任务、客户端、模块等的可视化管理和监控。
- **分布式部署支持**：支持Server的分布式部署，利用多节点架构提升系统的可用性和容错能力。

## 2. 系统架构设计

### 2.1 整体架构

系统分为三个主要部分：
1. **Server 部分**
   - **Listener 管理模块**：支持 TCP、ICMP、DNS、HTTP/2、WebSocket 等协议监听，每个 Listener 独立运行，支持动态创建、销毁和状态查询。
   - **加密模块**：提供 chacha20 和 aes 两种加密算法，设计统一接口供上层调用，并通过协议头自动识别加密算法。集成基于 ECDHE 的密钥交换机制，实现前向安全性。
   - **协议层**：统一封装数据收发、加解密、数据校验，确保所有通信均走统一标准，并实现流量混淆功能。预留扩展字段，支持未来功能扩展。
   - **管理模块**：负责任务调度、客户端连接管理、下发任务/模块控制指令，支持多种模块加载机制。引入智能化任务调度和优先级管理。
   - **认证系统**：实现基于证书或预共享密钥的双向认证机制，确保连接安全。
   - **Web管理界面**：提供基于Web的可视化管理和监控界面，支持实时数据统计和分析。

2. **Client 模板部分**
   - 客户端核心功能仅为与 Server 建立稳定连接并维持心跳。
   - **模块化设计**：支持多种模块加载机制（如 Linux 下的插件、Windows 下的 DLL 加载、进程间通信、WebAssembly），适配不同操作系统环境。
   - **安全防护**：内置反调试、反沙箱与环境检测功能，保护客户端免受分析。
   - **自适应能力**：根据网络环境自动选择最优协议和通信策略。

3. **Client Builder 工具**
   - 提供命令行参数配置，如 -protocol tcp,dns -mod shell，生成带有预置协议及内置模块的独立客户端可执行文件。
   - **内置机制**：
     - **主动策略**：若当前协议发生超时或异常，自动切换备用协议，并实现完整的状态同步。
     - **被动策略**：在 Server 下发切换命令时，客户端以原子操作方式切换至指定协议。
   - 同时支持打包预置模块（如 shell）以及动态接收远程下发模块。

### 2.2 模块间交互
- **通信协议**：Server 与 Client 之间基于统一协议层交互，协议包中包含协议版本、加密算法标识、数据类型等字段，预留扩展字段支持未来功能。
- **任务分发**：Server 端任务管理器将任务信息打包，并通过加密后的协议包发送给指定客户端。支持任务的批量操作和分组管理。
- **模块加载**：Server 可下发模块和指令，Client 端收到后根据目标平台选择合适的加载机制执行，并注册相应功能，后续 Server 可通过统一接口进行远程控制。

## 3. 技术细节

### 3.1 Server 端设计

#### 3.1.1 Listener 管理
- **支持协议**：TCP、ICMP、DNS、HTTP/2、WebSocket等。
- **动态管理**：
  - 使用线程安全的注册表结构管理每个监听实例的配置和状态。
  - 提供 API 用于创建、销毁、启动、停止和查询各 Listener 状态，确保端口不冲突。
  - 监控系统：实时监控各 Listener 的健康状态，自动恢复异常的监听服务。
- **示例配置**：
  - 启动 2 个 TCP 监听、1 个 DNS 监听、1 个 ICMP 监听；或仅启动 3 个 TCP 监听等灵活组合。
- **DNS 协议特殊处理**：
  - 实现域名分段编码，支持大数据传输
  - 加入随机时间间隔控制，避免异常 DNS 查询模式被检测
  - 处理 DNS 缓存问题，如使用唯一子域名和控制 TTL 值
- **HTTP/2和WebSocket支持**：
  - 实现基于HTTP/2的长连接通信，利用其多路复用特性
  - 支持WebSocket协议，便于穿透防火墙和代理

#### 3.1.2 加密模块设计
- **支持算法**：chacha20、aes（推荐使用 AES-GCM 模式提供认证加密）。
- **密钥管理**：
  - 基于 ECDHE 的密钥交换机制，确保前向安全性
  - 实现定期密钥轮换策略，降低密钥泄露风险
  - 每个客户端使用独立会话密钥，避免单点泄露影响全局
- **算法自动识别**：
  - 在协议包头中预留加密算法标识字段，格式预定义（例如：0x01 表示 aes，0x02 表示 chacha20）。
  - 接收到数据后，根据标识调用相应解密方法。
- **接口设计**：
  - 定义统一加密接口，支持加密、解密、密钥协商、随机化初始化向量（IV）生成等操作。
  - 采用工厂模式，根据协议头返回对应的加密器实例。

#### 3.1.3 协议层统一处理
- 封装数据包格式，建议采用 TLV（Type-Length-Value）结构，便于扩展和灵活解析。
- 协议头包含：协议版本、加密算法标识、数据类型、任务编号、校验码等信息，预留扩展字段。
- 对数据进行分片和重组，支持大数据包的传输及可靠性重传机制。
- **流量混淆**：
  - 实现流量特征变换，避免特征识别和流量分析
  - 支持伪装为常见协议（如 HTTP、HTTPS 等）
  - 加入抖动机制，避免固定通信模式被检测
  - 支持对抗机器学习检测的动态流量特征调整

#### 3.1.4 任务与客户端管理
- **任务管理**：
  - 任务调度系统，支持任务的创建、下发、状态跟踪、超时重发等功能。
  - 支持任务分类，如命令执行、模块下发、协议切换等。
  - 实现任务优先级和依赖关系管理，确保任务按正确顺序执行
  - 支持任务的批量操作和分组管理，便于大规模任务的下发和监控
  - 引入基于历史数据的智能化任务调度功能
- **客户端管理**：
  - 建立双向认证与心跳机制，客户端在连接时进行身份验证和注册。
  - 使用并发安全的数据结构管理客户端状态，支持在线查询和离线超时清理。
  - 容错机制：处理网络波动、连接中断情况，确保任务状态一致性

#### 3.1.5 模块下发与热加载支持
- **模块分发**：
  - Server 支持下发内置模块与动态模块，并根据客户端平台选择合适的模块格式。
  - 模块包中包含版本号、依赖信息、数字签名和安全校验码。
- **跨平台加载方案**：
  - Linux 系统：优先使用 Golang 插件（plugin）机制
  - Windows 系统：提供 DLL 加载或进程间通信机制
  - 通用方案：支持 WebAssembly 模块作为跨平台解决方案
  - 所有平台均提供基于 RPC 的备选通信方案

#### 3.1.6 Web管理界面
- 提供基于Web的管理界面，支持对Listener、任务、客户端、模块等的可视化管理和监控
- 实时数据统计和分析功能，包括任务执行进度、客户端在线状态、流量使用情况等
- 支持权限管理和多用户协作，便于团队使用

#### 3.1.7 分布式部署支持
- 支持Server的分布式部署，利用多节点架构提升系统的可用性和容错能力
- 实现分布式任务调度和数据同步机制，确保系统在大规模环境中的稳定运行

### 3.2 Client 模板设计

#### 3.2.1 核心功能
- 维持与 Server 的稳定连接，包括心跳、重连、状态同步与恢复。
- 支持多协议接入，内置 TCP、ICMP、DNS、HTTP/2、WebSocket 等监听/连接模块，确保在网络不稳定情况下能动态切换。
- 简化的通信接口：对 Server 下发的任务进行数据解析，并交由加载的模块处理后返回结果。
- **安全防护**：
  - 反调试机制，检测并应对动态分析工具
  - 反沙箱技术，识别虚拟环境与自动化分析工具
  - 内存保护措施，防止内存转储和敏感数据提取
  - 代码混淆和内存加密技术，防止逆向工程

#### 3.2.2 模块化扩展
- 设计统一模块接口，支持多种加载机制：
  - 内置/预编译模块方式
  - 动态库加载（平台相关实现）
  - 进程间通信（跨平台通用方案）
  - WebAssembly 模块（跨平台高兼容性方案）
- 针对 shell 模块、文件管理模块等，定义标准接口规范，确保 Server 端能动态调用模块内函数。
- 模块隔离：实现模块运行的安全隔离，避免单个模块崩溃影响整体系统
- 模块生命周期管理：支持模块的启动、暂停、恢复、销毁等操作

#### 3.2.3 自适应能力
- 环境感知：根据网络环境自动选择最优协议和通信策略
- 动态更新：支持客户端的动态更新功能，确保在不重新部署的情况下快速修复漏洞或增加新功能

### 3.3 Client Builder 工具

#### 3.3.1 构建逻辑
- 通过命令行参数（例如 builder -protocol tcp,dns -mod shell）选择需要内置的协议模块和功能模块。
- Builder 在编译阶段将指定模块打包进客户端，生成独立的可执行文件。
- 同时保留接口支持运行时接收 Server 下发的额外模块。

#### 3.3.2 主动与被动协议切换
- **主动策略**：
  - 客户端内置监控机制，对当前连接状态进行实时检测，当发生超时或异常时自动切换到预设的备用协议。
  - 完整状态同步：设计连接状态保存和恢复机制，确保协议切换过程中不丢失任务状态。
- **被动策略**：
  - Server 可通过协议包下发指令，要求客户端切换到指定协议。
  - 客户端收到指令后，以原子操作方式完成切换，防止切换过程中的状态不一致。

## 4. 接口定义与数据结构

### 4.1 Listener 接口
```go
type Listener interface {
    Start() error
    Stop() error
    Status() ListenerStatus
    Configure(config ListenerConfig) error
}

type ListenerStatus struct {
    Running bool
    Error   error
    Stats   map[string]interface{}
}

type ListenerConfig struct {
    Protocol string
    Address  string
    Port     int
    Options  map[string]interface{}
}
```

### 4.2 加密接口
```go
type Encryptor interface {
    Encrypt(plain []byte) ([]byte, error)
    Decrypt(cipher []byte) ([]byte, error)
    Algorithm() string
    ExchangeKey(publicKey []byte) ([]byte, error)
    RotateKey() error
}
```

### 4.3 通信协议数据包结构
- **协议头**（固定长度）：
  - 版本号、加密算法标识、数据类型、任务ID、校验码等
  - 预留扩展字段，支持未来功能扩展
- **数据体**：
  - TLV 结构字段，支持分片、重组和扩展

### 4.4 模块接口
```go
type Module interface {
    Init(params map[string]interface{}) error
    Exec(command string, args ...interface{}) (interface{}, error)
    Shutdown() error
    GetStatus() ModuleStatus
    GetCapabilities() []string
    Pause() error
    Resume() error
}

type ModuleStatus struct {
    Running bool
    Error   error
    Stats   map[string]interface{}
}
```

## 5. 安全与扩展性建议
1. **安全隔离**：
   - 在 Server 与 Client 之间使用基于证书或预共享密钥的双向认证机制，防止未授权访问。
   - 模块下发时加入数字签名和校验，确保模块来源合法且未被篡改。
   - 客户端实现运行时完整性自检，检测被篡改的情况。

2. **日志与审计**：
   - 对所有重要操作（如 Listener 状态变化、任务下发、模块加载）进行详细日志记录。
   - 实现日志分级机制（DEBUG、INFO、WARN、ERROR），便于快速定位问题。
   - 支持日志的远程集中存储和分析（如ELK Stack），便于大规模部署时的统一管理。
   - 支持高可信时间戳和防篡改日志记录机制。

3. **模块扩展**：
   - 采用接口抽象和多种插件机制，方便未来新增加密算法、通信协议和功能模块。
   - 针对 Golang 插件机制的局限（主要支持 Linux），实现多种备选方案：
     - Windows 平台采用 DLL 加载或进程间通信
     - 考虑 WebAssembly 作为跨平台模块格式
     - 提供基于 RPC 的通用调用机制
   - 提供模块开发的SDK和示例代码，降低第三方开发者的接入门槛。

4. **性能优化**：
   - 利用 Golang 的 goroutine 和 channel 进行并发管理，确保 Listener 管理器和任务调度模块的高效响应。
   - 对关键路径采用超时、重试机制和健康检查，确保系统高可用。
   - 实现资源使用限制，防止某个模块或任务消耗过多资源。
   - 针对高并发场景，优化Goroutine的调度和资源分配。

5. **配置管理**：
   - Server 和 Client 均应支持动态配置更新（例如通过配置文件、命令行参数或 API 调用），以便快速响应环境变化。
   - 配置文件加密存储，防止敏感信息泄露。
   - 提供配置变更的版本控制和回滚机制，防止配置错误导致系统不可用。

6. **隐蔽性与反检测技术**：
   - 增加对抗机器学习检测的功能，通过动态调整流量特征和行为模式，规避基于AI的流量分析。
   - 支持伪装为合法应用（如浏览器、邮件客户端）的行为模式，进一步提升隐蔽性。

7. **多语言支持**：
   - 提供多语言版本的客户端和管理工具，便于在国际化场景中使用。
   - 支持多语言的模块开发和加载机制，进一步提升系统的适用性。

8. **安全测试工具集成**：
   - 提供与常见安全测试工具（如Metasploit、Cobalt Strike）的集成接口，便于红队在合法测试中快速使用。
   - 增加对目标环境的自动化信息收集和漏洞扫描功能，提升测试效率。

## 6. 开发计划与建议
1. **需求确认阶段**
   - 与使用方详细确认协议字段、加密约定和模块接口规范。
   - 制定详细的功能测试用例和安全测试计划。

2. **架构设计与原型开发**
   - 先行搭建 Listener 管理器和统一协议层原型，验证多协议和动态管理功能。
   - 构建加密模块接口，进行 AES 与 chacha20 的对比测试。
   - 实现 ECDHE 密钥交换机制并验证其安全性。

3. **模块化与加载机制开发**
   - 设计并实现多平台兼容的模块管理框架，测试各种模块加载机制。
   - 对 Client Builder 工具进行命令行参数解析与打包，确保生成文件正确嵌入所选模块。

4. **系统集成与安全评估**
   - 集成所有模块，完成 Server 与 Client 的整体对接。
   - 进行全面安全测试，确保通信加密、双向认证及防检测功能完备。
   - 模拟真实环境下的检测系统，测试流量混淆和反检测效果。

5. **Web界面与分布式支持开发**
   - 开发基于Web的管理界面，实现可视化管理和监控功能。
   - 实现分布式部署支持，测试多节点环境下的系统稳定性和性能。

6. **文档与维护**
   - 编写详细的用户和开发文档，便于后续维护和扩展。
   - 设计自动化测试和持续集成流程，提升开发效率与代码质量。
   - 建立模块开发规范，便于第三方扩展开发。

## 7. 附录：技术选型与依赖
1. **核心依赖**：
   - Go 1.23.5+：核心开发语言
   - 加密库：golang.org/x/crypto
   - 网络库：net/http, net/http2, golang.org/x/net/websocket
   - 并发控制：sync, context

2. **可选依赖**：
   - WebAssembly支持：syscall/js, github.com/wasmerio/wasmer-go
   - Web界面：github.com/gin-gonic/gin, github.com/gorilla/websocket
   - 分布式支持：github.com/hashicorp/raft, github.com/hashicorp/serf

3. **开发工具**：
   - 构建工具：go build, go generate
   - 测试框架：testing, github.com/stretchr/testify
   - CI/CD：GitHub Actions, GitLab CI
